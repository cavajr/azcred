<p-blockUI [blocked]="blocked">
  <i class="fa fa-lock fa-5x" style="position:absolute;top:50%;left:50%"></i>
</p-blockUI>

<div class="row">
  <div class="col-xs-12 col-sm-12 col-md-3">
    <div class="card border-success">
      <div class="card-header">
        <strong>Fotografia</strong>
      </div>
      <div class="card-body">
        <img
          *ngIf="usuario.id"
          [src]="usuario.arquivo | imagem"
          class="img-circle rounded mx-auto d-block"
          width="150"
        />
        <img
          *ngIf="!usuario.id"
          [src]="'imagens/default.png' | imagem"
          class="img-circle rounded mx-auto d-block"
          width="150"
        />
      </div>
    </div>
  </div>

  <div class="col-xs-12 col-sm-12 col-md-9">
    <div class="card border-primary">
      <div class="card-header">
        <strong>{{ editando ? "Edição" : "Novo Registro" }}</strong>
      </div>
      <form #f="ngForm" autocomplete="off" (ngSubmit)="salvar(f)">
        <div class="card-body">
          <div class="form-group">
            <label>Ativo</label>
            <ng-select
              [class.is-invalid]="ativo && ativo.touched"
              [searchable]="false"
              [clearable]="false"
              [items]="ativos"
              [bindLabel]="'label'"
              [bindValue]="'value'"
              name="ativo"
              [(ngModel)]="usuario.ativo"
              #ativo="ngModel"
              required
            >
            </ng-select>
            <app-message
              [control]="ativo"
              error="required"
              text="O campo é obrigatório."
            ></app-message>
          </div>

          <div class="form-group">
            <label class="control-label">Nome</label>
            <input
              [class.is-invalid]="name.invalid && name.touched"
              type="text"
              name="name"
              class="form-control"
              required
              [(ngModel)]="usuario.name"
              #name="ngModel"
              oninput="this.value = this.value.toUpperCase()"
            />
            <app-message
              [control]="name"
              error="required"
              text="O nome é obrigatório."
            ></app-message>
          </div>
          <div class="row">
            <div class="col-md-12">
              <div class="form-group">
                <label for="email" class="control-label">E-mail</label>
                <input
                  id="email"
                  [class.is-invalid]="email.invalid && email.touched"
                  class="form-control"
                  type="text"
                  name="email"
                  required
                  email
                  [(ngModel)]="usuario.email"
                  #email="ngModel"
                />
                <app-message
                  [control]="email"
                  error="required"
                  text="O email é obrigatório."
                ></app-message>
                <app-message
                  [control]="email"
                  error="email"
                  text="Digite um email válido."
                ></app-message>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-9">
              <div class="form-group">
                <label for="senha" class="control-label">Senha</label>
                <input
                  id="senha"
                  type="password"
                  name="password"
                  class="form-control"
                  [(ngModel)]="usuario.password"
                  #password="ngModel"
                />
              </div>
            </div>

            <div class="col-md-3">
              <div class="form-group">
                <label>É Corretor?</label>
                <ng-select
                  [class.is-invalid]="acesso_externo && acesso_externo.touched"
                  [searchable]="false"
                  [clearable]="false"
                  [items]="externo"
                  [bindLabel]="'label'"
                  [bindValue]="'value'"
                  name="acesso_externo"
                  [(ngModel)]="usuario.acesso_externo"
                  #acesso_externo="ngModel"
                  required
                >
                </ng-select>
                <app-message
                  [control]="acesso_externo"
                  error="required"
                  text="O campo é obrigatório."
                ></app-message>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-12">
              <div class="form-group" *ngIf="usuario.acesso_externo === 1">
                <label class="control-label" for="corretor_id">Corretor</label>
                <ng-select
                  [(ngModel)]="usuario.corretor_id"
                  #corretor_id="ngModel"
                  name="corretor_id"
                  [selectOnTab]="true"
                  clearAllText="Limpar"
                  loadingText="Carregando..."
                  notFoundText="Nenhum registro encontrado"
                >
                  <ng-option
                    *ngFor="let corretor of listaCorretores"
                    [value]="corretor.id"
                    [disabled]="corretor.ativo == 'N'"
                  >
                    {{ corretor.nome }}
                  </ng-option>
                </ng-select>
              </div>
            </div>
          </div>

          <div class="row" *ngIf="usuario.acesso_externo != 1">
            <div class="col-md-12">
              <div class="form-group">
                <p-table
                  [columns]="cols"
                  [value]="grupos"
                  [(selection)]="selecionados"
                  dataKey="id"
                >
                  <ng-template pTemplate="caption">
                    Lista de Grupos
                  </ng-template>
                  <ng-template pTemplate="header">
                    <tr>
                      <th style="width: 3em">
                        <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                      </th>
                      <th>Nome</th>
                      <th>Descrição</th>
                    </tr>
                  </ng-template>
                  <ng-template
                    pTemplate="body"
                    let-rowData
                    let-columns="columns"
                  >
                    <tr [pSelectableRow]="rowData">
                      <td>
                        <p-tableCheckbox [value]="rowData"></p-tableCheckbox>
                      </td>
                      <td *ngFor="let col of columns">
                        {{ rowData[col.field] }}
                      </td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <button
            class="btn btn-sm btn-success"
            type="submit"
            [disabled]="f.invalid"
          >
            <i class="fa fa-save"></i>
            Salvar
          </button>
          <button
            class="btn btn-sm btn-primary"
            type="button"
            style="margin: 0 5px;"
            (click)="novo(f)"
          >
            <i class="fa fa-plus-circle"></i>
            Novo
          </button>
          <button
            routerLink="/usuarios"
            class="btn btn-sm btn-outline-danger"
            [disabled]="!auth.temPermissao('VISUALIZAR_USUARIO')"
          >
            <i class="fa fa-times"></i>
            Retornar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
